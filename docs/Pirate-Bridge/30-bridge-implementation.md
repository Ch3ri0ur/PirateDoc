# Implementation

The Bridge primarily has two components:

* One for communicating with the Arduino 
* and one to communicate with the clients.

In addition two further jobs fall under its umbrella:

* Providing a unified endpoint for the Bridge API, Spyglass and serving the Flag.
    * For this a reverse proxy, HTTPS and DNS need to be setup.

# Primary Components

As already stated the Bridge primarily has two components, one facing the serial port and one implementing a HTTP API. The components communicate internally by writing into a shared data structure for data to be sent / received. 

The components are written in [[Javascript]] and executed on [[NodeJS]].

## Communication with the Arduino

The Hook can send messages to the Raspberry PI "any time" but the communication to the Hook on the Arduino from the Raspberry PI is polling based with the Pirate Hook being the initiator. Here is more information about the implemented [serial protocol](../Pirate-Hook/pirate-serial-protocol.md). 



On the Node side a library called [serialport](https://serialport.io/) is used. With it the programm can connect to the serial port and  creates a event every time a new message is received. This message is parsed and depending on the [message type](../Pirate-Hook/serial-protocol.md) different handlers are used process the data. 

* On the first startup a set of configuration messages are sent from the Arduino, detailing the meta information about the variables that can be sent to and from the Arduino.
* If data is to be sent to the clients it is placed into a send buffer.
* If a request for data from the Arduino is received, another buffer is checked for outstanding control messages from the clients.

## Communication with the Clients

and uses the [[Express]] framework.

The server providing the interface exposes a set of endpoints. In general when request

The reverse proxy is provided by a server solution called [[caddy]].

[//begin]: # "Autogenerated link references for markdown compatibility"
[Javascript]: Theory\javascript "Javascript"
[NodeJS]: Theory\nodejs "Nodejs"
[Express]: Theory\express "Express"
[caddy]: ..\Pirate-Chart\Theory\caddy "Caddy"
[//end]: # "Autogenerated link references"